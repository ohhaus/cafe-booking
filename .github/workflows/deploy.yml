name: üöÄ CI/CD Cafe Booking

on:
  push:
    branches:
      - main

env:
  APP_IMAGE: ${{ secrets.DOCKER_USERNAME }}/cafe-booking-app
  NGINX_IMAGE: ${{ secrets.DOCKER_USERNAME }}/cafe-booking-nginx
  HEALTH_URL: https://bron-team4.hix-cloud.ru/health

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîê Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: üê≥ –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        uses: docker/build-push-action@v5
        with:
          context: infra/app
          file: infra/app/Dockerfile
          push: true
          tags: |
            ${{ env.APP_IMAGE }}:latest
            ${{ env.APP_IMAGE }}:${{ github.sha }}

      - name: üåê –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è NGINX
        uses: docker/build-push-action@v5
        with:
          context: infra/nginx
          file: infra/nginx/Dockerfile
          push: true
          tags: |
            ${{ env.NGINX_IMAGE }}:latest
            ${{ env.NGINX_IMAGE }}:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          script: |
            cd cafe-booking
            sudo docker compose -f docker-compose-production.yml pull
            sudo docker compose -f docker-compose-production.yml up -d --remove-orphans
            sudo docker image prune -af

      - name: üè• Health Check
        run: |
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞..."
          sleep 10
          
          for i in {1..30}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.HEALTH_URL }})
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ –°–µ—Ä–≤–∏—Å —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω! (HTTP 200)"
              exit 0
            fi
            
            echo "–ü–æ–ø—ã—Ç–∫–∞ $i/30 - –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞: $HTTP_CODE"
            sleep 5
          done
          
          echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –ø—Ä–æ—à–µ–ª health check –∑–∞ 150 —Å–µ–∫—É–Ω–¥!"
          exit 1

      - name: üì£ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
        if: success()
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚úÖ *–î–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω*
            
            üåø –í–µ—Ç–∫–∞: main
            üßæ –ö–æ–º–º–∏—Ç: `${{ github.sha }}`
            üè• Health: ${{ env.HEALTH_URL }}
            
            –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —à—Ç–∞—Ç–Ω–æ!

      - name: üì£ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if: failure()
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚ùå *–î–µ–ø–ª–æ–π –ø—Ä–æ–≤–∞–ª–µ–Ω*
            
            üåø –í–µ—Ç–∫–∞: main
            üßæ –ö–æ–º–º–∏—Ç: `${{ github.sha }}`
            
            –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}