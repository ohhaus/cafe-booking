name: üöÄ CI/CD Cafe Booking

on:
  push:
    branches:
      - main

env:
  APP_IMAGE: ${{ secrets.DOCKER_USERNAME }}/cafe-booking-app
  NGINX_IMAGE: ${{ secrets.DOCKER_USERNAME }}/cafe-booking-nginx
  HEALTH_URL: https://bron-team4.hix-cloud.ru/health

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      app_image: ${{ steps.set_app_image.outputs.image }}
      nginx_image: ${{ steps.set_nginx_image.outputs.image }}
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîê Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # --- Build & Push App ---
      - name: üê≥ –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        uses: docker/build-push-action@v5
        with:
          context: infra/app
          file: infra/app/Dockerfile
          push: true
          tags: |
            ${{ env.APP_IMAGE }}:latest
            ${{ env.APP_IMAGE }}:${{ github.sha }}

      - name: üìù –£—Å—Ç–∞–Ω–æ–≤–∫–∞ output –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        id: set_app_image
        run: echo "image=${{ env.APP_IMAGE }}:${{ github.sha }}" >> $GITHUB_OUTPUT

      # --- Build & Push NGINX ---
      - name: üåê –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è NGINX
        uses: docker/build-push-action@v5
        with:
          context: infra/nginx
          file: infra/nginx/Dockerfile
          push: true
          tags: |
            ${{ env.NGINX_IMAGE }}:latest
            ${{ env.NGINX_IMAGE }}:${{ github.sha }}

      - name: üìù –£—Å—Ç–∞–Ω–æ–≤–∫–∞ output –¥–ª—è NGINX
        id: set_nginx_image
        run: echo "image=${{ env.NGINX_IMAGE }}:${{ github.sha }}" >> $GITHUB_OUTPUT

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          script: |
            cd cafe-booking
            sudo docker compose -f docker-compose-production pull
            sudo docker compose -f docker-compose-production up -d --remove-orphans

            # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–±—Ä–∞–∑—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ NGINX
            sudo docker image prune -af --filter "reference=${{ env.APP_IMAGE }}:*"
            sudo docker image prune -af --filter "reference=${{ env.NGINX_IMAGE }}:*"

      - name: üè• Health Check
        run: |
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ –ø–æ ${{ env.HEALTH_URL }} ..."
          sleep 5
          for i in {1..30}; do
            RESULT=$(curl -s -w "%{http_code}" ${{ env.HEALTH_URL }})
            BODY="${RESULT::-3}"
            CODE="${RESULT: -3}"
            if [[ "$CODE" == "200" && "$BODY" == "ok" ]]; then
              echo "‚úÖ –°–µ—Ä–≤–∏—Å —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
              exit 0
            fi
            echo "–ü–æ–ø—ã—Ç–∫–∞ $i/30 - —Å–µ—Ä–≤–∏—Å –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤ (–∫–æ–¥ $CODE, –æ—Ç–≤–µ—Ç: $BODY)"
            sleep 5
          done
          echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –ø—Ä–æ—à–µ–ª health check –∑–∞ 150 —Å–µ–∫—É–Ω–¥!"
          exit 1

      - name: üì£ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
        if: success()
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚úÖ *–î–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω*

            üåø –í–µ—Ç–∫–∞: main
            üßæ –ö–æ–º–º–∏—Ç: `${{ github.sha }}`
            üè• Health: ${{ env.HEALTH_URL }}

            –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —à—Ç–∞—Ç–Ω–æ!

      - name: üì£ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if: failure()
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚ùå *–î–µ–ø–ª–æ–π –ø—Ä–æ–≤–∞–ª–µ–Ω*

            üåø –í–µ—Ç–∫–∞: main
            üßæ –ö–æ–º–º–∏—Ç: `${{ github.sha }}`

            –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
