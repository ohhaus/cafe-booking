name: Telegram PR Notifications

on:
  pull_request:
    types: [opened, synchronize, reopened, closed, ready_for_review]
  pull_request_review:
    types: [submitted, dismissed]
  pull_request_review_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract PR metadata
        id: pr-meta
        run: |
          PR_NUMBER=${{ github.event.number || github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_STATE="${{ github.event.pull_request.state }}"
          PR_BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          PR_HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"

          echo "PR_NUMBER=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "PR_TITLE=${PR_TITLE}" >> $GITHUB_OUTPUT
          echo "PR_AUTHOR=${PR_AUTHOR}" >> $GITHUB_OUTPUT
          echo "PR_URL=${PR_URL}" >> $GITHUB_OUTPUT
          echo "PR_STATE=${PR_STATE}" >> $GITHUB_OUTPUT
          echo "PR_BASE_BRANCH=${PR_BASE_BRANCH}" >> $GITHUB_OUTPUT
          echo "PR_HEAD_BRANCH=${PR_HEAD_BRANCH}" >> $GITHUB_OUTPUT

          if [[ "${{ github.event.action }}" != "closed" ]]; then
            COMMIT_COUNT=$(git rev-list --count ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} 2>/dev/null || echo "0")
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} 2>/dev/null | wc -l || echo "0")

            echo "COMMIT_COUNT=${COMMIT_COUNT}" >> $GITHUB_OUTPUT
            echo "CHANGED_FILES=${CHANGED_FILES}" >> $GITHUB_OUTPUT

            LABELS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              ${{ github.event.pull_request.issue_url }}/labels | jq -r '.[].name' | tr '\n' ', ' | sed 's/, $//' || echo "")

            if [[ -n "${LABELS}" ]]; then
              echo "PR_LABELS=${LABELS}" >> $GITHUB_OUTPUT
            else
              echo "PR_LABELS=" >> $GITHUB_OUTPUT
            fi
          fi

          if [[ "${{ github.event.action }}" == "closed" ]]; then
            echo "MERGED=${{ github.event.pull_request.merged }}" >> $GITHUB_OUTPUT

            if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
              MERGED_BY="${{ github.event.pull_request.merged_by.login }}"
              echo "CLOSED_BY=${MERGED_BY}" >> $GITHUB_OUTPUT
            else
              CLOSED_BY="${{ github.event.pull_request.closed_by.login }}"
              echo "CLOSED_BY=${CLOSED_BY}" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Format notification message
        id: format-message
        run: |
          MESSAGE=""

          case "${{ github.event_name }}/${{ github.event.action }}" in
            "pull_request/opened"|"pull_request/reopened")
              STATUS_EMOJI="üöÄ"
              STATUS_TEXT="–ù–æ–≤—ã–π Pull Request"
              if [[ "${{ github.event.action }}" == "reopened" ]]; then
                STATUS_EMOJI="‚Ü©Ô∏è"
                STATUS_TEXT="PR –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç"
              fi

              MESSAGE="${STATUS_EMOJI} ${STATUS_TEXT}

          üìå PR #${{ steps.pr-meta.outputs.PR_NUMBER }}: ${{ steps.pr-meta.outputs.PR_TITLE }}
          üë§ –ê–≤—Ç–æ—Ä: ${{ steps.pr-meta.outputs.PR_AUTHOR }}
          üåø –í–µ—Ç–∫–∞: ${{ steps.pr-meta.outputs.PR_HEAD_BRANCH }} ‚Üí ${{ steps.pr-meta.outputs.PR_BASE_BRANCH }}
          üìä –ò–∑–º–µ–Ω–µ–Ω–∏–π: ${{ steps.pr-meta.outputs.COMMIT_COUNT }} –∫–æ–º–º–∏—Ç(–æ–≤) | ${{ steps.pr-meta.outputs.CHANGED_FILES }} —Ñ–∞–π–ª(–æ–≤)"

              if [[ -n "${{ steps.pr-meta.outputs.PR_LABELS }}" ]]; then
                MESSAGE="${MESSAGE}
          üè∑Ô∏è –õ–µ–π–±–ª—ã: ${{ steps.pr-meta.outputs.PR_LABELS }}"
              fi

              MESSAGE="${MESSAGE}

          –û—Ç–∫—Ä—ã—Ç—å PR | ${{ steps.pr-meta.outputs.PR_URL }}"
              ;;

            "pull_request/synchronize")
              MESSAGE="üìù PR –û–±–Ω–æ–≤–ª–µ–Ω

          üìå PR #${{ steps.pr-meta.outputs.PR_NUMBER }}: ${{ steps.pr-meta.outputs.PR_TITLE }}
          üë§ –ê–≤—Ç–æ—Ä: ${{ steps.pr-meta.outputs.PR_AUTHOR }}
          üìä –ò–∑–º–µ–Ω–µ–Ω–∏–π: ${{ steps.pr-meta.outputs.COMMIT_COUNT }} –∫–æ–º–º–∏—Ç(–æ–≤) | ${{ steps.pr-meta.outputs.CHANGED_FILES }} —Ñ–∞–π–ª(–æ–≤)
          üåø ${{ steps.pr-meta.outputs.PR_HEAD_BRANCH }} ‚Üí ${{ steps.pr-meta.outputs.PR_BASE_BRANCH }}

          –û—Ç–∫—Ä—ã—Ç—å PR | ${{ steps.pr-meta.outputs.PR_URL }}"
              ;;

            "pull_request/closed")
              if [[ "${{ steps.pr-meta.outputs.MERGED }}" == "true" ]]; then
                MERGE_EMOJI="‚úÖ"
                MERGE_TEXT="–í–ª–∏—Ç"
                MERGER="üë§ –í–ª–∏–ª: ${{ steps.pr-meta.outputs.CLOSED_BY }}"
              else
                MERGE_EMOJI="‚ùå"
                MERGE_TEXT="–ó–∞–∫—Ä—ã—Ç"
                MERGER="üë§ –ó–∞–∫—Ä—ã–ª: ${{ steps.pr-meta.outputs.CLOSED_BY }}"
              fi

              DURATION=$(( ($(date +%s) - $(date -d "${{ github.event.pull_request.created_at }}" +%s)) / 86400 ))

              MESSAGE="${MERGE_EMOJI} PR ${MERGE_TEXT}

          üìå PR #${{ steps.pr-meta.outputs.PR_NUMBER }}: ${{ steps.pr-meta.outputs.PR_TITLE }}
          üë§ –ê–≤—Ç–æ—Ä: ${{ steps.pr-meta.outputs.PR_AUTHOR }}
          ${MERGER}
          ‚è±Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${DURATION} –¥–Ω.

          –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å PR | ${{ steps.pr-meta.outputs.PR_URL }}"
              ;;

            "pull_request/ready_for_review")
              MESSAGE="üìã PR –ì–æ—Ç–æ–≤ –∫ —Ä–µ–≤—å—é

          üìå PR #${{ steps.pr-meta.outputs.PR_NUMBER }}: ${{ steps.pr-meta.outputs.PR_TITLE }}
          üë§ –ê–≤—Ç–æ—Ä: ${{ steps.pr-meta.outputs.PR_AUTHOR }}

          –ù–∞—á–∞—Ç—å —Ä–µ–≤—å—é | ${{ steps.pr-meta.outputs.PR_URL }}"
              ;;

            "pull_request_review/submitted")
              REVIEW_STATE="${{ github.event.review.state }}"
              REVIEWER="${{ github.event.review.user.login }}"
              REVIEW_BODY="${{ github.event.review.body }}"
              PR_TITLE="${{ github.event.pull_request.title }}"

              case $REVIEW_STATE in
                "approved")
                  EMOJI="‚úÖ"
                  TEXT="–æ–¥–æ–±—Ä–∏–ª"
                  ;;
                "changes_requested")
                  EMOJI="‚ö†Ô∏è"
                  TEXT="–∑–∞–ø—Ä–æ—Å–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è"
                  ;;
                "commented")
                  EMOJI="üí¨"
                  TEXT="–æ—Å—Ç–∞–≤–∏–ª –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
                  ;;
                *)
                  EMOJI="üìù"
                  TEXT="–æ—Å—Ç–∞–≤–∏–ª –æ—Ç–∑—ã–≤"
                  ;;
              esac

              MESSAGE="${EMOJI} –ù–æ–≤—ã–π –æ—Ç–∑—ã–≤ –Ω–∞ PR

          üìå PR #${{ github.event.pull_request.number }}: ${PR_TITLE}
          üë§ –†–µ–≤—å—é–≤–µ—Ä: ${REVIEWER}
          üìã –°—Ç–∞—Ç—É—Å: ${TEXT}"

              if [[ -n "${REVIEW_BODY}" && "${REVIEW_BODY}" != "null" ]]; then
                REVIEW_PREVIEW=$(echo "${REVIEW_BODY}" | head -c 200)
                if [[ ${#REVIEW_BODY} -gt 200 ]]; then
                  REVIEW_PREVIEW="${REVIEW_PREVIEW}..."
                fi
                MESSAGE="${MESSAGE}
          üí≠ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${REVIEW_PREVIEW}"
              fi

              MESSAGE="${MESSAGE}

          –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤ | ${{ github.event.review.html_url }}"
              ;;

            "pull_request_review/dismissed")
              REVIEWER="${{ github.event.review.user.login }}"
              PR_TITLE="${{ github.event.pull_request.title }}"

              MESSAGE="üóëÔ∏è –û—Ç–∑—ã–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω

          üìå PR #${{ github.event.pull_request.number }}: ${PR_TITLE}
          üë§ –ö–µ–º: ${REVIEWER}

          –û—Ç–∫—Ä—ã—Ç—å PR | ${{ steps.pr-meta.outputs.PR_URL }}"
              ;;

            "pull_request_review_comment/created")
              COMMENTER="${{ github.event.comment.user.login }}"
              PR_TITLE="${{ github.event.pull_request.title }}"
              COMMENT_BODY="${{ github.event.comment.body }}"

              COMMENT_PREVIEW=$(echo "${COMMENT_BODY}" | head -c 150)
              if [[ ${#COMMENT_BODY} -gt 150 ]]; then
                COMMENT_PREVIEW="${COMMENT_PREVIEW}..."
              fi

              MESSAGE="üí¨ –ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Ä–µ–≤—å—é

          üìå PR #${{ github.event.pull_request.number }}: ${PR_TITLE}
          üë§ –ê–≤—Ç–æ—Ä: ${COMMENTER}
          üí≠ –¢–µ–∫—Å—Ç: ${COMMENT_PREVIEW}

          –û—Ç–≤–µ—Ç–∏—Ç—å | ${{ github.event.comment.html_url }}"
              ;;
          esac

          REPO_NAME="${{ github.repository }}"
          FINAL_MESSAGE="${REPO_NAME}

          ${MESSAGE}"

          {
            echo "message<<EOF"
            echo "${FINAL_MESSAGE}"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Send notification to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: ${{ steps.format-message.outputs.message }}
          disable_web_page_preview: true

      - name: Send critical notifications
        if: github.event.action == 'closed' && steps.pr-meta.outputs.MERGED == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            üéâ PR —É—Å–ø–µ—à–Ω–æ –≤–ª–∏—Ç –≤ ${{ steps.pr-meta.outputs.PR_BASE_BRANCH }}

            üìå PR #${{ steps.pr-meta.outputs.PR_NUMBER }}: ${{ steps.pr-meta.outputs.PR_TITLE }}
            üë§ –ê–≤—Ç–æ—Ä: ${{ steps.pr-meta.outputs.PR_AUTHOR }}
            üëë –í–ª–∏–ª: ${{ steps.pr-meta.outputs.CLOSED_BY }}

            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å | ${{ steps.pr-meta.outputs.PR_URL }}