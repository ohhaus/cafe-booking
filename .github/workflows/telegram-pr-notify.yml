name: Telegram PR Notifications

on:
  pull_request:
    types: [opened, synchronize, closed]
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Deduplication guard
        id: dedupe
        uses: actions/cache@v4
        with:
          path: .dedupe
          key: pr-${{ github.event.pull_request.number }}-${{ github.event.action }}
          restore-keys: pr-${{ github.event.pull_request.number }}-

      - name: Skip duplicated PR event
        if: steps.dedupe.outputs.cache-hit == 'true'
        run: exit 0

      - name: Get commit diff
        id: commits
        if: github.event.action == 'synchronize'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          owner="${{ github.repository_owner }}"
          repo="$(basename ${{ github.repository }})"
          before="${{ github.event.before }}"
          after="${{ github.event.after }}"

          response=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$owner/$repo/compare/$before...$after")

          count=$(echo "$response" | jq '.commits | length')
          messages=$(echo "$response" | jq -r '.commits[].commit.message' | head -n 5)

          echo "count=$count" >> $GITHUB_OUTPUT
          {
            echo "list<<EOF"
            echo "$messages"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # -------------------------
      - name: Detect review state change
        id: review
        if: github.event_name == 'pull_request_review'
        run: |
          prev="${{ github.event.pull_request.review_decision }}"
          curr="${{ github.event.review.state }}"

          if [[ "$prev" != "$curr" && "$prev" != "null" ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "from=$prev" >> $GITHUB_OUTPUT
            echo "to=$curr" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Build raw message
        id: msg
        shell: bash
        run: |
          repo="${{ github.repository }}"
          pr="${{ github.event.pull_request.number }}"
          title="${{ github.event.pull_request.title }}"
          url="${{ github.event.pull_request.html_url }}"
          author="${{ github.event.pull_request.user.login }}"

          msg=""
          send_now="false"

          if [[ "${{ github.event.action }}" == "opened" ]]; then
            msg=$(echo -e "üöÄ *–ù–æ–≤—ã–π PR*\n\nüìå #$pr: $title\nüë§ –ê–≤—Ç–æ—Ä: $author\n\nüëâ $url")
            send_now="true"

          elif [[ "${{ github.event.action }}" == "closed" ]]; then
            if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
              EMOJI="‚úÖ"
              TEXT="–í–ª–∏—Ç"
              MERGER="üë§ –í–ª–∏–ª: ${{ github.event.pull_request.merged_by.login }}"
            else
              EMOJI="‚ùå"
              TEXT="–ó–∞–∫—Ä—ã—Ç"
              MERGER="üë§ –ó–∞–∫—Ä—ã–ª: ${{ github.event.pull_request.closed_by.login }}"
            fi

            DURATION=$(( ($(date +%s) - $(date -d "${{ github.event.pull_request.created_at }}" +%s)) / 86400 ))

            msg=$(echo -e "$EMOJI PR $TEXT\n\nüìå #$pr: $title\nüë§ –ê–≤—Ç–æ—Ä: $author\n$MERGER\n‚è±Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${DURATION} –¥–Ω.\n\n–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å PR | $url")
            send_now="true"

          elif [[ "${{ github.event.action }}" == "synchronize" ]]; then
            body=$(echo -e "üìù *–ù–æ–≤—ã–µ –∫–æ–º–º–∏—Ç—ã –≤ PR #$pr*\n\nüìå $title\nüë§ –ê–≤—Ç–æ—Ä: $author\n‚ûï –ù–æ–≤—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤: ${{ steps.commits.outputs.count }}\n\n$(echo "${{ steps.commits.outputs.list }}" | sed 's/^/‚Ä¢ /')\n\nüëâ $url")
            mkdir -p .throttle
            echo "$body" >> .throttle/events.log

          elif [[ "${{ github.event_name }}" == "pull_request_review" && "${{ steps.review.outputs.changed }}" == "true" ]]; then
            body=$(echo -e "üîÑ *–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ review*\n\nüìå #$pr: $title\nüë§ –†–µ–≤—å—é–≤–µ—Ä: ${{ github.event.review.user.login }}\nüîÅ ${{ steps.review.outputs.from }} ‚Üí ${{ steps.review.outputs.to }}\n\nüëâ $url")
            mkdir -p .throttle
            echo "$body" >> .throttle/events.log
          fi

          echo "message=$msg" >> $GITHUB_OUTPUT
          echo "send_now=$send_now" >> $GITHUB_OUTPUT

      - name: Send immediate Telegram notification
        if: steps.msg.outputs.send_now == 'true'
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: ${{ steps.msg.outputs.message }}
          format: markdown
          disable_web_page_preview: true

      - name: Send aggregated summary
        if: steps.msg.outputs.send_now == 'false'
        run: |
          COOLDOWN=180
          FILE=".throttle/last_sent"
          NOW=$(date +%s)

          if [[ -f "$FILE" ]]; then
            LAST=$(cat $FILE)
          else
            LAST=0
          fi

          if (( NOW - LAST >= COOLDOWN )); then
            echo "$NOW" > $FILE
            CONTENT=$(cat .throttle/events.log)
            if [[ -n "$CONTENT" ]]; then
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
                -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
                -d parse_mode="Markdown" \
                -d text="üßµ *–°–≤–æ–¥–∫–∞ —Å–æ–±—ã—Ç–∏–π*\n\n$CONTENT"
              rm -f .throttle/events.log
            fi
          fi
